# 机器指令的执行过程

1. **取指令（Fetch）**
   CPU根据程序计数器（PC）的地址从内存读取指令，存入指令寄存器（IR），并更新PC指向下一条指令。
2. **解码（Decode）**
   控制单元解析指令的操作码（Opcode），确定操作类型（如加法）和操作数（寄存器或内存地址）。
3. **执行（Execute）**
   算术逻辑单元（ALU）执行运算（如加减法），或计算内存地址（如加载/存储指令）。
4. **访存（Memory Access，可选）**
   仅限加载（Load）或存储（Store）指令：从内存读取数据或向内存写入数据。
5. **写回（Write Back）**
   将运算结果或内存读取的数据写入目标寄存器。

# 栈

![image-20250522141813773](https://cdn.jsdelivr.net/gh/Dec-lxh/Images@main/img/20250522141820.png)

# GOT劫持

全局偏移表（Global Offset Table，GOT）（存放外部函数地址的数据段）和过程链接表（Procedure Linkage Table，PLT）（获取数据段存放的外部函数地址的代码）

全局偏移表在ELF文件中以独立的节区存在，共包含两类，对应的节区名为`.got`和`.got.plt`，其中，`.got`存放所有对于外部变量引用的地址；`.got.plt`保存所有对于外部函数引用的地址，对于延迟绑定主要使用`.got.plt`表。`.got.plt`表的基本结构如下图所示

![image-20250523161753401](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250523161753401.png)

![image-20250523161843044](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250523161843044.png)





# 栈溢出

**原理**：向栈中写入超出缓冲区长度的数据，覆盖返回地址或关键数据，从而控制程序执行流

```
void function(char *str) {
    char buffer[16];
    strcpy(buffer, str); // 无长度检查
}
漏洞点：strcpy未检查输入长度，导致buffer溢出。
```

# 堆溢出

**原理**：覆盖堆内存中的元数据（如`chunk`头），篡改内存分配逻辑，实现代码执行

```
#define BUFSIZE 256
 int main(int argc, char **argv) {
 	char *buf;
 	buf = (char*)malloc(sizeof(char)*BUFSIZE);
	strcpy(buf, argv[1]);
 }
没有限制输入长度
```



# 格式化字符串漏洞

**原理**：攻击者控制格式化字符串参数（如`占位符%x和%n`），实现任意内存读写

```
不安全的代码
int func(char *user) {
 printf(user);// 未使用固定格式字符串
}
 安全的代码
int func(char *user) {
 printf("%s", user);
}
```

**释放后使用 (Use After Free, UAF)**

- **原理**：释放内存后仍保留引用，攻击者可重新分配内存并篡改数据。
- ![image-20250523162938594](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250523162938594.png)

# 延迟绑定



# Shellcode



# 约定调用





# malloc和free的工作流程





# Intel语法与 AT&T语法区别

![image-20250522142826142](https://cdn.jsdelivr.net/gh/Dec-lxh/Images@main/img/20250522142826.png)



缓解措施

# 函数调用时栈的布局情况

![image-20250522142116734](https://cdn.jsdelivr.net/gh/Dec-lxh/Images@main/img/20250522142116.png)

|------------------|
|    参数2 (5)      | <-- ebp + 12
|    参数1 (3)      | <-- ebp + 8
|    返回地址        | <-- ebp + 4
| 保存的ebp（旧ebp） | <-- ebp
|    局部变量        | <-- ebp - 4
|------------------|
|  保存的寄存器（ebx）| <-- ebp - 8
|  保存的寄存器（esi）| <-- ebp - 12
|------------------|